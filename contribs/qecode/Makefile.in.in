# Qecode Makefile
# Largely inspired from the map makefile by Gregoire Dooms
#
# Jeremie Vautard, Universite d'Orleans

#
gecode_top_srcdir = $(top_srcdir)
qecode_top_srcdir = $(curdir)


KERNELDLL := $(KERNELDLL:%=../../%)
INTDLL := $(INTDLL:%=../../%)
MMDLL := $(MMDLL:%=../../%)
SUPPORTDLL := $(SUPPORTDLL:%=../../%)
SUPPORTOBJ := $(SUPPORTOBJ:%=../../%)


ifeq "$(LIBPREFIX)" "$(LINKPREFIX)"
LINKSET:=../../$(LINKSET)
LINKSUPPORT:=../../$(LINKSUPPORT)
LINKKERNEL:=../../$(LINKKERNEL)
LINKINT:=../../$(LINKINT)
LINKMM:=../../$(LINKMM)
LINKSEARCH:=../../$(LINKSEARCH)
LINKALL := $(LINKMM) $(LINKSET) $(LINKINT) $(LINKSEARCH) $(LINKKERNEL)
else
EXTRALINKFLAGS := -L../..
endif

#
# QECODE COMPONENTS
#

QECODESRC0 = implicative.cc warner.cc extensivecomparator.cc NaiveValueHeuristics.cc qecore.cc qsolver.cc scoreSDF.cc FirstFailValueHeuristic.cc myspace.cc
QECODEHDR0 = 


QECODESRC	= $(QECODESRC0)
QECODEHDR	= qecode.hh $(QECODEHDR0)
QECODEOBJ	= $(QECODESRC:%.cc=%$(OBJSUFFIX))
QECODEFLAGS	= -L$(qecode_top_srcdir)../../ -I../../gecode -I$(qecode_top_srcdir)../../  
QECODEDLL	= $(LIBPREFIX)@QECODE@$(DLLSUFFIX)
QECODESTATICLIB	= $(LIBPREFIX)@QECODE@$(STATICLIBSUFFIX)
QECODELIB	= $(LIBPREFIX)@QECODE@$(LIBSUFFIX)
LINKQECODE	= $(LINKPREFIX)@QECODE@$(LINKSUFFIX)

LINKALL := $(LINKALL) $(LINKQECODE)

ALLLIB :=  $(ALLLIB) $(QECODELIB) 

DLLTARGETS = $(QECODEDLL)


ifeq "@BUILDSTATIC@" "yes"
STATICTARGETS = \
	$(QECODESTATICLIB)
else
STATICTARGETS=
endif

LIBTARGETS= $(DLLTARGETS) $(STATICTARGETS)


all : $(LIBTARGETS) 

#
# Object targets
#

%$(OBJSUFFIX): %.cc
	$(CXX) $(CXXFLAGS)  $(QECODEFLAGS) \
	@COMPILEOBJ@$@ @CXXIN@ $<
%$(SBJSUFFIX): %.cc
	$(CXX) $(CXXFLAGS)   $(QECODEFLAGS) \
	@COMPILESBJ@$@ @CXXIN@ $<




#
# DLL Targets
#

ifeq "$(DLLSUFFIX)" "$(LIBSUFFIX)"
#linux
$(QECODEDLL): $(QECODEOBJ) $(KERNELDLL) $(INTDLL) $(SUPPORTDLL) $(MMDLL)
	$(CXX) $(DLLFLAGS) $(QECODEOBJ)  $(QECODEFLAGS) \
		@DLLPATH@ $(LINKKERNEL) $(LINKINT) $(LINKMM) $(LINKSUPPORT) \
		@LINKOUTPUT@$(QECODEDLL)
	$(CREATELINK) $@ $(@:%$(DLLSUFFIX)=%$(SOLINKSUFFIX))
	$(CREATELINK) $@ $(@:%$(DLLSUFFIX)=%$(SOSUFFIX))
else
#win
$(QECODEDLL) $(QECODELIB): $(QECODEOBJ) $(KERNELDLL) $(INTDLL) $(SUPPORTDLL) $(MMDLL)
	$(CXX) $(DLLFLAGS) $(QECODEOBJ)  $(QECODEFLAGS)\
		@DLLPATH@ $(LINKKERNEL) $(LINKINT) $(LINKMM) $(LINKSUPPORT)  \
		@LINKOUTPUT@$(QECODEDLL)
endif


#
# Static libraries
#

$(QECODESTATICLIB): $(QECODEOBJ)
	$(AR) $(ARFLAGS) $@ $(QECODEOBJ)
	$(RANLIB) $@

# 
# EXE targets
#
#


#for linux: ?
CXXFLAGS := $(CXXFLAGS) $(QECODEFLAGS) 


#
# Autoconf
#

configure: configure.ac 
	autoconf
config.status: configure
	../../config.status --recheck
	./config.status --recheck
# use the sustitutions from gecode to generate the Makefile.in
Makefile.in: Makefile.in.in ../../config.status 
	../../config.status --file ./Makefile.in:./Makefile.in.in

# use the sustitutions from configure to generate the Makefile
Makefile: Makefile.in ./config.status 
	./config.status --file ./Makefile:./Makefile.in


.PHONY: clean veryclean distclean
clean:
	$(RMF) $(QECODEOBJ) $(QECODESBJ)

veryclean: clean
	$(RMF) $(LIBTARGETS)
	$(RMF) $(LIBTARGETS:%$(DLLSUFFIX)=%.exp) $(LIBTARGETS:%$(DLLSUFFIX)=%.lib)
	$(RMF) $(LIBTARGETS:%$(DLLSUFFIX)=%.ilk) $(LIBTARGETS:%$(DLLSUFFIX)=%.pdb)
	$(RMF) $(QECODEDLL)

distclean: veryclean
	$(RMF) config.log config.status

.PHONY: doc
doc: $(QECODEHDR) $(QECODESRC) 
	mkdir -p doc/html
	doxygen doxygen.conf
